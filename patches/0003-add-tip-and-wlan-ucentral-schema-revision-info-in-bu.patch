From dfeb6490f93cb5689ab3b10759048b7f0728b29d Mon Sep 17 00:00:00 2001
From: Shubham Vishwakarma <shubhamvis98@fossfrog.in>
Date: Wed, 25 Jun 2025 11:24:34 +0000
Subject: [PATCH] add tip and wlan-ucentral-schema revision info in build

Signed-off-by: John Crispin <john@phrozen.org>
Signed-off-by: Tanya Singh <tanya_singh@accton.com>
Signed-off-by: Shubham Vishwakarma <shubhamvis98@fossfrog.in>
---
 include/version.mk                            | 10 +++++++
 package/base-files/Makefile                   |  1 +
 package/base-files/files/etc/banner           |  1 +
 package/base-files/files/etc/openwrt_release  |  3 ++
 package/base-files/files/etc/openwrt_version  |  1 +
 ...p-revision-info-to-system.board-call.patch | 29 +++++++++++++++++++
 scripts/getver.sh                             | 17 +++++++++++
 7 files changed, 62 insertions(+)
 create mode 100644 package/system/procd/patches/0001-procd-add-tip-revision-info-to-system.board-call.patch

diff --git a/include/version.mk b/include/version.mk
index b1e414f189..313ee3e193 100644
--- a/include/version.mk
+++ b/include/version.mk
@@ -63,6 +63,13 @@ VERSION_PRODUCT:=$(if $(VERSION_PRODUCT),$(VERSION_PRODUCT),Generic)
 VERSION_HWREV:=$(call qstrip,$(CONFIG_VERSION_HWREV))
 VERSION_HWREV:=$(if $(VERSION_HWREV),$(VERSION_HWREV),v0)
 
+VERSION_TIP:=$(shell $(TOPDIR)/scripts/getver.sh wlan-ap)
+
+VERSION_TIP_VERSION:=$(shell $(TOPDIR)/scripts/getver.sh wlan-ap-version)
+VERSION_TIP_VERSION:=$(if $(VERSION_TIP_VERSION),$(VERSION_TIP_VERSION),devel)
+
+VERSION_UCENTRAL_SCHEMA:=$(shell $(TOPDIR)/scripts/getver.sh ucentral-schema-version)
+
 define taint2sym
 $(CONFIG_$(firstword $(subst :, ,$(subst +,,$(subst -,,$(1))))))
 endef
@@ -112,5 +119,8 @@ VERSION_SED_SCRIPT:=$(SED) 's,%U,$(call sed_escape,$(VERSION_REPO)),g' \
 	-e 's,%s,$(call sed_escape,$(VERSION_SUPPORT_URL)),g' \
 	-e 's,%f,$(call sed_escape,$(VERSION_FIRMWARE_URL)),g' \
 	-e 's,%P,$(call sed_escape,$(VERSION_PRODUCT)),g' \
+	-e 's,%a,$(call sed_escape,$(VERSION_TIP)),g' \
+	-e 's,%x,$(call sed_escape,$(VERSION_TIP_VERSION)),g' \
+	-e 's,%B,$(call sed_escape,$(VERSION_UCENTRAL_SCHEMA)),g' \
 	-e 's,%h,$(call sed_escape,$(VERSION_HWREV)),g' \
 	-e 's,%B,$(call sed_escape,$(SOURCE_DATE_EPOCH)),g'
diff --git a/package/base-files/Makefile b/package/base-files/Makefile
index 693d259ee4..b314ce185b 100644
--- a/package/base-files/Makefile
+++ b/package/base-files/Makefile
@@ -248,6 +248,7 @@ endif
 
 	$(if $(CONFIG_TARGET_PREINIT_DISABLE_FAILSAFE), \
 		rm -f $(1)/etc/banner.failsafe,)
+	$(CP) $(1)/etc/openwrt_release $(TOPDIR)/tmp/
 
 ifneq ($(CONFIG_USE_APK),)
 	mkdir -p $(1)/etc/apk/repositories.d
diff --git a/package/base-files/files/etc/banner b/package/base-files/files/etc/banner
index f3af3c014f..1422ea45ad 100644
--- a/package/base-files/files/etc/banner
+++ b/package/base-files/files/etc/banner
@@ -4,5 +4,6 @@
  |_______||   __|_____|__|__||________||__|  |____|
           |__| W I R E L E S S   F R E E D O M
  -----------------------------------------------------
+ ApNos-%a-%x
  %D %V, %C
  -----------------------------------------------------
diff --git a/package/base-files/files/etc/openwrt_release b/package/base-files/files/etc/openwrt_release
index d03400ca05..cbb8f4b820 100644
--- a/package/base-files/files/etc/openwrt_release
+++ b/package/base-files/files/etc/openwrt_release
@@ -5,3 +5,6 @@ DISTRIB_TARGET='%S'
 DISTRIB_ARCH='%A'
 DISTRIB_DESCRIPTION='%D %V %C'
 DISTRIB_TAINTS='%t'
+DISTRIB_TIP='%D %V %C / TIP-%x-%a'
+DISTRIB_TIP_VERSION='%x'
+DISTRIB_UCENTRAL_SCHEMA_REVISION='%B'
diff --git a/package/base-files/files/etc/openwrt_version b/package/base-files/files/etc/openwrt_version
index 48157ed97f..bb0ef233ac 100644
--- a/package/base-files/files/etc/openwrt_version
+++ b/package/base-files/files/etc/openwrt_version
@@ -1 +1,2 @@
+ApNos-%a
 %C
diff --git a/package/system/procd/patches/0001-procd-add-tip-revision-info-to-system.board-call.patch b/package/system/procd/patches/0001-procd-add-tip-revision-info-to-system.board-call.patch
new file mode 100644
index 0000000000..37970a36af
--- /dev/null
+++ b/package/system/procd/patches/0001-procd-add-tip-revision-info-to-system.board-call.patch
@@ -0,0 +1,29 @@
+From 4f4f7daca6d33a2591dca6f20e4e55be1f8554d2 Mon Sep 17 00:00:00 2001
+From: Shubham Vishwakarma <shubhamvis98@fossfrog.in>
+Date: Wed, 25 Jun 2025 16:47:54 +0530
+Subject: [PATCH] procd: add tip revision info to system.board call
+
+Signed-off-by: John Crispin <john@phrozen.org>
+Signed-off-by: Shubham Vishwakarma <shubhamvis98@fossfrog.in>
+---
+ system.c | 4 ++++
+ 1 file changed, 4 insertions(+)
+
+diff --git a/system.c b/system.c
+index 7a4c24d..2117d5e 100644
+--- a/system.c
++++ b/system.c
+@@ -283,6 +283,10 @@ static int system_board(struct ubus_context *ctx, struct ubus_object *obj,
+ 				key = "builddate";
+ 			else if (!strcasecmp(key, "FIRMWARE_URL"))
+ 				key = "firmware_url";
++			else if (!strcasecmp(key, "DISTRIB_TIP"))
++				key = "tip-revision";
++			else if (!strcasecmp(key, "DISTRIB_TIP_VERSION"))
++				key = "tip-version";
+ 			else
+ 				continue;
+ 
+-- 
+2.47.2
+
diff --git a/scripts/getver.sh b/scripts/getver.sh
index 0659d8004a..7ba529a003 100755
--- a/scripts/getver.sh
+++ b/scripts/getver.sh
@@ -3,6 +3,23 @@ export LANG=C
 export LC_ALL=C
 [ -n "$TOPDIR" ] && cd $TOPDIR
 
+[ "$1" = "wlan-ap" ] && {
+	cd ..
+	git log -n 1 --format="%h"
+	exit 0
+}
+
+[ "$1" = "wlan-ap-version" ] && {
+	cd ..
+	git branch | cut -d' ' -f2
+	exit 0
+}
+
+[ "$1" = "ucentral-schema-version" ] && {
+    cat ./package/feeds/ucentral/ucentral-schema/Makefile | grep PKG_SOURCE_VERSION | awk -F= '{print substr($2,1,7)}'
+    exit 0
+}
+
 GET_REV=$1
 
 try_version() {
-- 
2.25.1

